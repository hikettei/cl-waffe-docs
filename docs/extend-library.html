<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
  Extend library &ndash; cl-waffe
</title>
    <link rel="stylesheet" href="static/style.css"/>
    
  <link rel="stylesheet" href="static/highlight.css"/>
  <script src="static/highlight.js"></script>
  <style>
   /* Highlight the current top-level TOC item, and hide the TOC of all other items */

   .toc a[data-node="extend-library"] {
       /*color: #AD3108;*/
   }

   .toc ol {
       display: none;
   }

   .toc li a[data-node="extend-library"] {
       font-weight: bold;
   }

   .toc li a[data-node="extend-library"] + ol {
       display: block;
   }

   .toc li a[data-node="extend-library"] + ol li {
       margin-left: 10px;
   }
  </style>

  </head>
  <body>
    
  <h1 class="doc-title">cl-waffe</h1>
  <article id="article" data-section="extend-library">
    <aside>
      <ol class="toc"><li><a href="overview.html" data-node="overview">Overview</a><ol><li><a href="overview.html#welcome-to-cl-waffe!" data-node="welcome-to-cl-waffe!">Welcome to cl-waffe!</a></li><li><a href="overview.html#problems" data-node="problems">Problems</a></li><li><a href="overview.html#sections" data-node="sections">Sections</a></li><li><a href="overview.html#pull-requests" data-node="pull-requests">Pull Requests</a></li><li><a href="overview.html#contacts" data-node="contacts">Contacts</a></li><li><a href="overview.html#lla-setting" data-node="lla-setting">LLA Setting</a></li><li><a href="overview.html#when-memory-exhausted" data-node="when-memory-exhausted">When Memory Exhausted</a></li></ol></li><li><a href="mnist-tutorial.html" data-node="mnist-tutorial">MNIST Tutorial</a><ol><li><a href="mnist-tutorial.html#first" data-node="first">First</a></li><li><a href="mnist-tutorial.html#define-your-model" data-node="define-your-model">Define Your Model</a></li><li><a href="mnist-tutorial.html#define-your-dataset" data-node="define-your-dataset">Define Your Dataset</a><ol><li><a href="cl-waffe's-dataset--waffedataset.html" data-node="cl-waffe's-dataset--waffedataset">cl-waffe's Dataset: WaffeDataSet</a></li></ol></li><li><a href="mnist-tutorial.html#train-your-model" data-node="train-your-model">Train Your Model</a></li></ol></li><li><a href="using-tensor.html" data-node="using-tensor">Using Tensor</a><ol><li><a href="using-tensor.html#basic-tensor-operations" data-node="basic-tensor-operations">Basic Tensor Operations</a></li><li><a href="using-tensor.html#building-computation-nodes" data-node="building-computation-nodes">Building Computation Nodes</a><ol><li><a href="using-tensor.html#construct-tensors" data-node="construct-tensors">Construct Tensors</a><ol><li><a href="using-tensor.html#constants" data-node="constants">Constants</a></li><li><a href="using-tensor.html#parameter-tensors" data-node="parameter-tensors">Parameter Tensors</a></li><li><a href="using-tensor.html#sysconst" data-node="sysconst">Sysconst</a></li></ol></li></ol></li><li><a href="using-tensor.html#accessing-tensor" data-node="accessing-tensor">Accessing Tensor</a></li><li><a href="using-tensor.html#backward-and-predicting-mode" data-node="backward-and-predicting-mode">backward and predicting mode</a></li><li><a href="using-tensor.html#calling-forward-of-cl-waffe's-objects" data-node="calling-forward-of-cl-waffe's-objects">Calling Forward of cl-waffe's objects</a></li><li><a href="using-tensor.html#displaying-tensors" data-node="displaying-tensors">Displaying Tensors</a></li><li><a href="using-tensor.html#types" data-node="types">Types</a></li><li><a href="using-tensor.html#lazy-evaluation" data-node="lazy-evaluation">Lazy evaluation</a></li><li><a href="using-tensor.html#broadcasting" data-node="broadcasting">Broadcasting</a></li><li><a href="using-tensor.html#jit" data-node="jit">JIT</a></li><li><a href="using-tensor.html#tracing" data-node="tracing">Tracing</a></li><li><a href="using-tensor.html#compute-tensors-in-a-destructive-way" data-node="compute-tensors-in-a-destructive-way">Compute tensors in a destructive way</a><ol><li><a href="using-tensor.html#creating-destructive-operations" data-node="creating-destructive-operations">Creating Destructive Operations</a></li></ol></li></ol></li><li><a href="extend-library.html" data-node="extend-library">Extend library</a><ol><li><a href="extend-library.html#defmodel" data-node="defmodel">defmodel</a><ol><li><a href="extend-library.html#initialize-and-call-model" data-node="initialize-and-call-model">Initialize and call model</a></li><li><a href="extend-library.html#clos-style" data-node="clos-style">CLOS Style</a></li></ol></li><li><a href="extend-library.html#deftrainer" data-node="deftrainer">deftrainer</a></li><li><a href="extend-library.html#defoptimizer" data-node="defoptimizer">defoptimizer</a></li><li><a href="extend-library.html#defnode" data-node="defnode">defnode</a></li><li><a href="extend-library.html#defdataset" data-node="defdataset">defdataset</a></li></ol></li><li><a href="cl-waffe.html" data-node="cl-waffe">cl-waffe</a><ol><li><a href="package--cl-waffe.html" data-node="package--cl-waffe">Package :cl-waffe</a></li><li><a href="0-sections.html" data-node="0-sections">Sections</a></li><li><a href="model-and-node.html" data-node="model-and-node">Model And Node</a></li><li><a href="1-defmodel.html" data-node="1-defmodel">defmodel</a></li><li><a href="2-defnode.html" data-node="2-defnode">defnode</a></li><li><a href="trainer.html" data-node="trainer">Trainer</a></li><li><a href="3-deftrainer.html" data-node="3-deftrainer">deftrainer</a></li><li><a href="datasets.html" data-node="datasets">Datasets</a></li><li><a href="4-defdataset.html" data-node="4-defdataset">defdataset</a></li><li><a href="optimizer.html" data-node="optimizer">optimizer</a></li><li><a href="5-defoptimizer.html" data-node="5-defoptimizer">defoptimizer</a></li><li><a href="documentation-template.html" data-node="documentation-template">Documentation Template</a></li></ol></li><li><a href="cl-waffe.nn.html" data-node="cl-waffe.nn">cl-waffe.nn</a><ol><li><a href="exported.html" data-node="exported">Exported</a></li></ol></li><li><a href="cl-waffe.optimizers.html" data-node="cl-waffe.optimizers">cl-waffe.optimizers</a><ol><li><a href="6-sections.html" data-node="6-sections">Sections</a></li><li><a href="training-models-with-optimizer.html" data-node="training-models-with-optimizer">Training Models With Optimizer</a></li></ol></li><li><a href="cl-waffe.io.html" data-node="cl-waffe.io">cl-waffe.io</a><ol><li><a href="7-exported.html" data-node="7-exported">Exported</a></li></ol></li><li><a href="cl-waffe.caches.html" data-node="cl-waffe.caches">cl-waffe.caches</a><ol><li><a href="8-exported.html" data-node="8-exported">Exported</a></li></ol></li><li><a href="operators.html" data-node="operators">Operators</a><ol><li><a href="!shape.html" data-node="!shape">!shape</a></li><li><a href="!dims.html" data-node="!dims">!dims</a></li><li><a href="!size.html" data-node="!size">!size</a></li><li><a href="!zeros.html" data-node="!zeros">!zeros</a></li><li><a href="!ones.html" data-node="!ones">!ones</a></li><li><a href="!fill.html" data-node="!fill">!fill</a></li><li><a href="!arange.html" data-node="!arange">!arange</a><ol><li><a href="(-!arange-stop-).html" data-node="(-!arange-stop-)">(!arange stop)</a></li><li><a href="(-!arange-start-stop-).html" data-node="(-!arange-start-stop-)">(!arange start stop)</a></li><li><a href="(-!arange-start-stop-step-).html" data-node="(-!arange-start-stop-step-)">(!arange start stop step)</a></li></ol></li><li><a href="!random.html" data-node="!random">!random</a><ol><li><a href="when-limit=fixnum.html" data-node="when-limit=fixnum">When limit=fixnum</a></li><li><a href="when-limit=single-float.html" data-node="when-limit=single-float">When limit=single-float</a></li><li><a href="when-limit=-(-cons-single-float1-single-float2-).html" data-node="when-limit=-(-cons-single-float1-single-float2-)">When limit=(cons single-float1 single-float2)</a></li></ol></li><li><a href="!random-with.html" data-node="!random-with">!random-with</a></li><li><a href="!init-with.html" data-node="!init-with">!init-with</a></li><li><a href="!normal.html" data-node="!normal">!normal</a></li><li><a href="!randn.html" data-node="!randn">!randn</a></li><li><a href="!beta.html" data-node="!beta">!beta</a></li><li><a href="!gamma.html" data-node="!gamma">!gamma</a></li><li><a href="!chisquare.html" data-node="!chisquare">!chisquare</a></li><li><a href="!bernoulli.html" data-node="!bernoulli">!bernoulli</a></li><li><a href="!binomial.html" data-node="!binomial">!binomial</a></li><li><a href="9-!shape.html" data-node="9-!shape">!shape</a></li><li><a href="10-!dims.html" data-node="10-!dims">!dims</a></li><li><a href="11-!size.html" data-node="11-!size">!size</a></li><li><a href="!zeros-like.html" data-node="!zeros-like">!zeros-like</a></li><li><a href="!ones-like.html" data-node="!ones-like">!ones-like</a></li><li><a href="!full-like.html" data-node="!full-like">!full-like</a></li><li><a href="!add.html" data-node="!add">!add</a><ol><li><a href="examples.html" data-node="examples">Examples</a></li></ol></li><li><a href="!sub.html" data-node="!sub">!sub</a><ol><li><a href="12-examples.html" data-node="12-examples">Examples</a></li></ol></li><li><a href="!mul.html" data-node="!mul">!mul</a><ol><li><a href="13-examples.html" data-node="13-examples">Examples</a></li></ol></li><li><a href="!div.html" data-node="!div">!div</a><ol><li><a href="14-examples.html" data-node="14-examples">Examples</a></li></ol></li><li><a href="!dot.html" data-node="!dot">!dot</a><ol><li><a href="example.html" data-node="example">Example</a></li></ol></li><li><a href="!sum.html" data-node="!sum">!sum</a><ol><li><a href="arguments.html" data-node="arguments">arguments</a></li><li><a href="15-example.html" data-node="15-example">Example</a></li></ol></li><li><a href="!mean.html" data-node="!mean">!mean</a><ol><li><a href="16-example.html" data-node="16-example">Example</a></li></ol></li><li><a href="!exp.html" data-node="!exp">!exp</a><ol><li><a href="17-example.html" data-node="17-example">Example</a></li></ol></li><li><a href="!pow.html" data-node="!pow">!pow</a><ol><li><a href="18-example.html" data-node="18-example">Example</a></li></ol></li><li><a href="!sqrt.html" data-node="!sqrt">!sqrt</a><ol><li><a href="19-example.html" data-node="19-example">Example</a></li></ol></li><li><a href="!log.html" data-node="!log">!log</a><ol><li><a href="20-example.html" data-node="20-example">Example</a></li></ol></li><li><a href="!sin.html" data-node="!sin">!sin</a><ol><li><a href="21-example.html" data-node="21-example">Example</a></li></ol></li><li><a href="!cos.html" data-node="!cos">!cos</a><ol><li><a href="22-example.html" data-node="22-example">Example</a></li></ol></li><li><a href="!tan.html" data-node="!tan">!tan</a><ol><li><a href="23-example.html" data-node="23-example">Example</a></li></ol></li><li><a href="!asin.html" data-node="!asin">!asin</a></li><li><a href="!acos.html" data-node="!acos">!acos</a></li><li><a href="!atan.html" data-node="!atan">!atan</a></li><li><a href="!sinh.html" data-node="!sinh">!sinh</a><ol><li><a href="24-example.html" data-node="24-example">Example</a></li></ol></li><li><a href="!cosh.html" data-node="!cosh">!cosh</a><ol><li><a href="25-example.html" data-node="25-example">Example</a></li></ol></li><li><a href="!tanh.html" data-node="!tanh">!tanh</a></li><li><a href="!asinh.html" data-node="!asinh">!asinh</a></li><li><a href="!acosh.html" data-node="!acosh">!acosh</a></li><li><a href="!atanh.html" data-node="!atanh">!atanh</a></li><li><a href="!matmul.html" data-node="!matmul">!matmul</a></li><li><a href="!unsqueeze.html" data-node="!unsqueeze">!unsqueeze</a><ol><li><a href="26-example.html" data-node="26-example">Example</a></li></ol></li><li><a href="!squeeze.html" data-node="!squeeze">!squeeze</a><ol><li><a href="27-example.html" data-node="27-example">Example</a></li></ol></li><li><a href="!transpose.html" data-node="!transpose">!transpose</a><ol><li><a href="28-example.html" data-node="28-example">Example</a></li></ol></li><li><a href="!transpose1.html" data-node="!transpose1">!transpose1</a><ol><li><a href="29-example.html" data-node="29-example">Example</a></li></ol></li><li><a href="!repeats.html" data-node="!repeats">!repeats</a><ol><li><a href="30-example.html" data-node="30-example">Example</a></li></ol></li><li><a href="!reshape.html" data-node="!reshape">!reshape</a><ol><li><a href="31-example.html" data-node="31-example">Example</a></li></ol></li><li><a href="!abs.html" data-node="!abs">!abs</a></li><li><a href="!where.html" data-node="!where">!where</a><ol><li><a href="32-example.html" data-node="32-example">Example</a></li></ol></li><li><a href="!index.html" data-node="!index">!index</a></li><li><a href="!filter.html" data-node="!filter">!filter</a></li><li><a href="!argmax.html" data-node="!argmax">!argmax</a><ol><li><a href="33-example.html" data-node="33-example">Example</a></li></ol></li><li><a href="!argmin.html" data-node="!argmin">!argmin</a><ol><li><a href="34-example.html" data-node="34-example">Example</a></li></ol></li><li><a href="!<=.html" data-node="!<=">!&lt;=</a></li><li><a href="!>=.html" data-node="!>=">!&gt;=</a></li><li><a href="!einsum.html" data-node="!einsum">!einsum</a></li><li><a href="!ravel.html" data-node="!ravel">!ravel</a></li><li><a href="!flatten.html" data-node="!flatten">!flatten</a></li><li><a href="!aref.html" data-node="!aref">!aref</a></li><li><a href="!dotensors.html" data-node="!dotensors">!dotensors</a></li><li><a href="!set-batch.html" data-node="!set-batch">!set-batch</a></li><li><a href="!softmax.html" data-node="!softmax">!softmax</a></li><li><a href="!sigmoid.html" data-node="!sigmoid">!sigmoid</a></li><li><a href="!relu.html" data-node="!relu">!relu</a></li><li><a href="!gelu.html" data-node="!gelu">!gelu</a></li><li><a href="!leakey-relu.html" data-node="!leakey-relu">!leakey-relu</a></li><li><a href="!swish.html" data-node="!swish">!swish</a></li></ol></li><li><a href="neural-networks.html" data-node="neural-networks">Neural Networks</a><ol><li><a href="model-list.html" data-node="model-list">model-list</a><ol><li><a href="parameters.html" data-node="parameters">Parameters</a></li><li><a href="forward.html" data-node="forward">Forward</a></li><li><a href="35-example.html" data-node="35-example">Example</a></li></ol></li><li><a href="linearlayer.html" data-node="linearlayer">Linearlayer</a><ol><li><a href="36-parameters.html" data-node="36-parameters">Parameters</a></li><li><a href="shape.html" data-node="shape">Shape</a></li><li><a href="37-forward.html" data-node="37-forward">Forward</a></li><li><a href="38-example.html" data-node="38-example">Example</a></li></ol></li><li><a href="denselayer.html" data-node="denselayer">DenseLayer</a><ol><li><a href="39-parameters.html" data-node="39-parameters">Parameters</a></li><li><a href="40-shape.html" data-node="40-shape">Shape</a></li><li><a href="41-forward.html" data-node="41-forward">Forward</a></li><li><a href="42-example.html" data-node="42-example">Example</a></li></ol></li><li><a href="dropout.html" data-node="dropout">Dropout</a><ol><li><a href="43-parameters.html" data-node="43-parameters">Parameters</a></li><li><a href="44-shape.html" data-node="44-shape">Shape</a></li><li><a href="45-forward.html" data-node="45-forward">Forward</a></li></ol></li><li><a href="batchnorm2d.html" data-node="batchnorm2d">BatchNorm2d</a><ol><li><a href="46-parameters.html" data-node="46-parameters">Parameters</a></li><li><a href="47-shape.html" data-node="47-shape">Shape</a></li><li><a href="48-example.html" data-node="48-example">Example</a></li></ol></li><li><a href="layernorm.html" data-node="layernorm">LayerNorm</a></li><li><a href="embedding.html" data-node="embedding">Embedding</a><ol><li><a href="parameter.html" data-node="parameter">Parameter</a></li><li><a href="49-shape.html" data-node="49-shape">Shape</a></li><li><a href="50-example.html" data-node="50-example">Example</a></li></ol></li><li><a href="rnn.html" data-node="rnn">RNN</a><ol><li><a href="51-parameters.html" data-node="51-parameters">Parameters</a></li><li><a href="52-shape.html" data-node="52-shape">Shape</a></li><li><a href="53-example.html" data-node="53-example">Example</a></li></ol></li><li><a href="lstm.html" data-node="lstm">LSTM</a></li><li><a href="gru.html" data-node="gru">GRU</a></li><li><a href="maxpooling.html" data-node="maxpooling">MaxPooling</a></li><li><a href="avgpooling.html" data-node="avgpooling">AvgPooling</a></li><li><a href="conv1d.html" data-node="conv1d">Conv1D</a></li><li><a href="conv2d.html" data-node="conv2d">Conv2D</a></li><li><a href="transformer.html" data-node="transformer">Transformer</a></li><li><a href="transformerencoderlayer.html" data-node="transformerencoderlayer">TransformerEncoderLayer</a></li><li><a href="transformerdecoderlayer.html" data-node="transformerdecoderlayer">TransformerDecoderLayer</a></li><li><a href="crossentropy.html" data-node="crossentropy">CrossEntropy</a></li><li><a href="softmaxcrossentropy.html" data-node="softmaxcrossentropy">SoftMaxCrossEntropy</a></li><li><a href="mse.html" data-node="mse">MSE</a></li><li><a href="l1norm.html" data-node="l1norm">L1Norm</a></li><li><a href="l2norm.html" data-node="l2norm">L2Norm</a></li><li><a href="binarycrossentropy.html" data-node="binarycrossentropy">BinaryCrossEntropy</a></li><li><a href="kldivloss.html" data-node="kldivloss">KLdivLoss</a></li><li><a href="cosinesimilarity.html" data-node="cosinesimilarity">CosineSimilarity</a></li></ol></li><li><a href="optimizers.html" data-node="optimizers">Optimizers</a><ol><li><a href="sgd.html" data-node="sgd">SGD</a><ol><li><a href="cl-waffe's-optimizer--sgd.html" data-node="cl-waffe's-optimizer--sgd">cl-waffe's Optimizer: SGD</a></li></ol></li><li><a href="momentum.html" data-node="momentum">Momentum</a><ol><li><a href="cl-waffe's-optimizer--momentum.html" data-node="cl-waffe's-optimizer--momentum">cl-waffe's Optimizer: Momentum</a></li></ol></li><li><a href="adagrad.html" data-node="adagrad">AdaGrad</a><ol><li><a href="cl-waffe's-optimizer--adagrad.html" data-node="cl-waffe's-optimizer--adagrad">cl-waffe's Optimizer: AdaGrad</a></li></ol></li><li><a href="rmsprop.html" data-node="rmsprop">RMSProp</a><ol><li><a href="cl-waffe's-optimizer--rmsprop.html" data-node="cl-waffe's-optimizer--rmsprop">cl-waffe's Optimizer: RMSProp</a></li></ol></li><li><a href="adam.html" data-node="adam">Adam</a><ol><li><a href="cl-waffe's-optimizer--adam.html" data-node="cl-waffe's-optimizer--adam">cl-waffe's Optimizer: Adam</a></li></ol></li><li><a href="adamw.html" data-node="adamw">AdamW</a></li><li><a href="radam.html" data-node="radam">RAdam</a></li></ol></li></ol>
    </aside>
    <main class="codex-section">
      <header>
        <h2 class="section-title">Extend library</h2>
      </header>
      <div class="content">
        <p>All features of cl-waffe is exported for users, users can extend it as they wish.</p><p>The first section describes defmodel/deftrainer which will be most used macros.</p><p>The rest sections describe defnode/defoptimizer/defdataset which will be a little difficult for users to understand.</p><h1 id="defmodel">defmodel</h1><p>To put it bluntly, what defmodel to cl-waffe is what class(nn.Modules): to PyTorch.</p><p>Internally, defmodel is a macro for just defining defstruct, but can be used like CLOS Style.
<div class="codex-doc-node codex-operator codex-macro"><code class="codex-name">defmodel</code><code class="codex-lambda-list">(name args &amp;key (parameters nil) forward (optimize nil) (document An model, defined by cl-waffe))</code><div class="codex-docstring"><p>This macro defines a cl-waffe model as <code class="codex-param">name</code>.</p><p>At the same time, a constructor <code class="codex-param">name</code> is defined and you can initialize your model like:</p><pre><code class="lisp">(cl-waffe.nn:LinearLayer 100 20) ; =&gt; [Model: Linearlayer]
</code></pre><p>
</p><dl><dt>name</dt><dd>Your model and constructor name</dd><dt>args</dt><dd>The arguments of a constructor</dd><dt>parameters</dt><dd><p>The parameters your model has.</p><p>Every time you initialize the model, the parameters are initialized.</p><p>Note that <code class="codex-param">defmodel</code> behaves like class.</p><p>The arguments are the same as <a href="http://l1sp.org/cl/defstruct"><code>defstruct</code></a></p><p>Format Example: ((param-name param-initial-value &amp;key (type your-type)))</p></dd><dt>optimize</dt><dd>when t, your forward slot is defined with (declare (optimize (speed 3)(space 0)(debug 0))). It helps faster training after you ensured debugged.</dd><dt>forward</dt><dd><p>Define here the forward propagation of your model.</p><p>When backward, <b>Automatic differentiation applies</b>.</p></dd></dl><p>
</p></div></div>
</p><p>For example, defines seq2seq's encoder.
</p><pre><code class="lisp">(defmodel Encoder (vocab-size embedding-dim hidden-size)
  :parameters ((embedding (Embedding vocab-size embedding-dim :pad-idx 0))
               (layer     (RNN embedding-dim hidden-size :num-layers 1)))
  :forward ((x)
	    (with-calling-layers x
	      (embedding x)
	      (layer x))))
</code></pre><p>(defmodel Encoder (vocab-size embedding-dim hidden-size) ~) says, The constructor of it is (Encoder vocab-size embedding-dim hidden-size) And these parameters will be used when initializing :parameters.</p><p>:parameters have Parameters of each object, that is, each time model is initialized, (Embedding ~) and (RNN ~) are created and inserted to Encoder's embedding, layer.</p><p>:forward defines forward-step.</p><p>There is no need to define :backward as automatic differentiation is enabled inside the defmodel. That is, in defmodel's forward, <b>all calculations must be done in cl-waffe's APIs</b> otherwise computation nodes would be broken.</p><h2 id="initialize-and-call-model">Initialize and call model</h2><p>Let's create encoder and call forward.</p><pre><code class="lisp">(setq model (Encoder 10 16 10))
;[Model: ENCODER]

(call model (!ones `(10 10)))
;#Const((((-2.31... 3.048... ~ 2.551... -2.98...)         
;                   ...
;         (-2.31... 3.048... ~ 2.551... -2.98...))        
;                 ...
;        ((-2.31... 3.048... ~ 2.551... -2.98...)         
;                   ...
;         (-2.31... 3.048... ~ 2.551... -2.98...))) :mgl t :shape (10 10 10))

(backward (!sum *))
; NIL
; Backward process is done correctly!
</code></pre><p>
</p><h2 id="clos-style">CLOS Style</h2><p>(This is available in other macros as well.)</p><p>This is obviously but you can define method for each cl-waffe objects.</p><p>Each parameter can be accessed by using slot-value or each inherent accessor.</p><pre><code class="lisp">(defmethod print-object ((model Encoder) stream)
     (format stream &quot;[Seq2Seq Encoder which contains: ~a and ~a]&quot;
                    (slot-value model 'embedding)
		    (encoder-layer model)))
		    
(print model)
;[Seq2Seq Encoder which contains: [Model: EMBEDDING] and [Model: RNN]]
</code></pre><p>See also for more APIs: <a href="./cl-waffe.html#1-defmodel">document</a>
</p><p>
</p><h1 id="deftrainer">deftrainer</h1><p>See: <a href="./cl-waffe.html#trainer">document</a>.</p><h1 id="defoptimizer">defoptimizer</h1><p>See: <a href="./cl-waffe.html#optimizer">document</a>.
</p><h1 id="defnode">defnode</h1><p>defnode is a macro for defining a computation node itself in contrast to defmodel defining calculations using operators defined by defnode.</p><p>defnode requires :forward :backward to be fulfilled.</p><p>cl-waffe's APIs aren't necessary to be used in each step of :forward :backward as long as WaffeTensor is returned.</p><p>For example, defining (!transpose1 ...) without using cl-waffe's APIs.
</p><pre><code class="lisp">(defnode Transpose1Tensor (shape)
  :optimize t
  :parameters ((prev-shape nil)(shape shape))
  :forward ((x)
	    (setf (self prev-shape)(!shape x))
	    (with-facet (array ((value x) 'array :direction :input))
	      (sysconst (array-to-mat (numcl:transpose array)))))
  :backward ((dy)
	     (list (!transpose1 dy (self prev-shape)))))

(defun !transpose1 (x &amp;rest result)
   (call (Transpose1Tensor (assure-tensor result))(assure-tensor x)))

(setq a (!randn `(10 10)))
(setq a (!transpose1 a))
(print (cl-waffe::waffetensor-state a))
; [Node : TRANSPOSE1TENSOR]
; Backward created correctly.
</code></pre><p>mgl-mat provides an macro <code class="codex-param">with-facet</code>(<a href="https://github.com/melisgl/mgl-mat">See original repos</a>), which is used to directly access cl's array etc.</p><p>In other example, defining dropout.
</p><pre><code class="lisp">; An implementation of Inverted Dropout.
(defnode Dropout (&amp;optional (dropout-rate 0.5))
  :optimize t
  :parameters ((dropout-rate
		(if (and (&gt; dropout-rate 0.0)
			 (&lt; dropout-rate 1.0))
		    dropout-rate
		    (error &quot;cl-waffe.nn: Dropout(x), x must be in the range of 0.0&lt;x&lt;1.0 where x is a single-float.&quot;)))
	       (mask T))
  :forward ((x)
	    (if (eql (self mask) T) ; is first call?
		(setf (self mask)(!zeros (!shape x))))
	    
	    (if *no-grad* ; predict mode
		x
		(progn
		  (!modify (self mask) :bernoulli (self dropout-rate))
		  (!modify (!mul (self mask) x) :*= (/ 1 (- 1 (self dropout-rate)))))))

  :backward ((dy)
	     (list (!mul (self mask) dy))))
</code></pre><p>Tips: using T as a default parameter is convinient since cl-waffe's optimizer can detect discontinuities in the computation nodes.</p><p>See also for more APIs: <a href="./cl-waffe.html#2-defnode">document</a>
</p><h1 id="defdataset">defdataset</h1><p>
See: <a href="./cl-waffe.html#datasets">document</a>.</p><p>Todo: parallelize/make its memory-usage less.</p><p>
</p>
      </div>
    </main>
  </article>
  <footer>
    <div class="info">
      Created with <a href="https://github.com/CommonDoc/codex">Codex</a>.
    </div>
  </footer>
  <script>
   HighlightLisp.highlight_auto();
  </script>

  </body>
</html>
